# Coverage Testing for Monorepo

This document explains the coverage testing setup for the slog monorepo.

## Overview

The coverage system is designed to handle multiple Go modules in a monorepo,
running tests with coverage for each module separately and then merging the
results. It also generates configuration for Codecov to properly track coverage
for each module using flags.

## Key Components

### 1. Module Index (`.tmp/index`)

Generated by `gen_index.sh`, this file contains information about all modules
in the repository in the format:

```text
module_name:directory:go_module_path
```

### 2. Coverage Script (`make_coverage.sh`)

This script:

- Reads the module index
- Runs `go test -coverprofile` for each module using `go -C` to change directory
- Shows progress with module name and directory
- Merges all coverage files into a single `coverage.out`
- Optionally generates an HTML report

Environment variables:

- `GO`: Go command to use (default: `go`)
- `GOTEST_FLAGS`: Additional flags for `go test`
- `COVERAGE_HTML`: Set to `true` to generate HTML report

### 3. Codecov Script (`make_codecov.sh`)

This script generates two files for Codecov integration:

#### `codecov.yml`

Configuration file that:

- Defines flags for each module.
- Sets up path mappings so coverage is attributed correctly.
- Configures PR comment behaviour.
- Sets coverage targets and thresholds.

#### `codecov.sh`

Shell script that:

- Downloads the Codecov CLI with integrity verification.
- Uploads each module's coverage file with its specific flag.
- Uses relative paths from the script directory.
- Cleans up after execution.

## Usage

### Local Development

Run tests with coverage:

```bash
make coverage
```

Generate HTML report:

```bash
COVERAGE_HTML=true make coverage
```

### CI/CD Integration

The GitHub workflow:

1. Runs `make codecov` which runs coverage and generates Codecov files
2. Executes `.tmp/coverage/codecov.sh` to upload coverage files
3. Each module's coverage is uploaded with its specific flag

## Monorepo Benefits

This setup provides:

- **Module isolation**: Each module's coverage is tracked separately
- **Flag management**: Codecov flags allow filtering coverage by module
- **Proper attribution**: Code changes affect only the relevant module's
  coverage
- **Carryforward support**: Missing coverage data doesn't fail the build

## Troubleshooting

### No coverage files found

Ensure the index file exists:

```bash
make .tmp/index
```

### Tests failing

Check test output for specific module:

```bash
go -C <module_dir> test -v
```

### Coverage merge issues

The coverage files are merged using simple concatenation. If you need more
advanced merging, consider using external tools.
