# Coverage Testing for Monorepo

This document explains the coverage testing setup for monorepos.

## Overview

The coverage system is designed to handle multiple Go modules in a monorepo,
running tests with coverage for each module separately and then merging the
results. It also generates configuration for Codecov to properly track coverage
for each module using flags.

The system follows Codecov's best practices for monorepo coverage tracking by
uploading separate coverage reports for each module with its corresponding flag.
This ensures accurate per-module coverage attribution.

## Key Components

### 1. Module Index (`.tmp/index`)

Generated by `gen_index.sh`, this file contains information about all modules
in the repository in the format:

```text
module_name:directory:go_module_path
```

### 2. Coverage Script (`make_coverage.sh`)

This script:

- Reads the module index.
- Runs `go test -coverprofile -coverpkg=./... ./...` for each module using
  `go -C` to change directory (requires Go 1.23+). This tests all packages
  recursively and instruments all packages for coverage, not just those with
  test files.
- Shows progress with module name and directory.
- Generates individual coverage files with pattern `coverage_${name}.prof`.
- Creates multiple output formats: `.prof`, `.func`, `.html`, and `.stdout`.
- Uses atomic coverage mode for accurate concurrent testing results.

Environment variables:

- `GO`: Go command to use (default: `go`).
- `GOTEST_FLAGS`: Additional flags for `go test`.
- `COVERAGE_HTML`: Set to `true` to generate HTML report.

### 3. Codecov Script (`make_codecov.sh`)

This script generates the upload script for Codecov integration:

#### `codecov.sh`

Shell script that:

- Downloads the Codecov CLI with integrity verification.
- Uploads each module's coverage file with its specific flag.
- Uses relative paths from the script directory.
- Cleans up after execution.

**Important**: The script makes separate upload calls for each module to ensure
proper flag attribution. Codecov warns against uploading a single report with
multiple flags as it can result in erroneous coverage.

## Usage

### Local Development

Run tests with coverage:

```bash
make coverage
```

Generate HTML report:

```bash
COVERAGE_HTML=true make coverage
```

### CI/CD Integration

The GitHub workflow:

1. Runs `make clean-coverage codecov` to ensure clean state and generate
   coverage.
2. Executes `.tmp/coverage/codecov.sh` to upload coverage files.
3. Each module's coverage is uploaded with its specific flag.

## Monorepo Benefits

This setup provides:

- **Module isolation**: Each module's coverage is tracked separately.
- **Flag management**: Codecov flags allow filtering coverage by module.
- **Proper attribution**: Code changes affect only the relevant module's
  coverage.
- **Carryforward support**: Missing coverage data doesn't fail the build.

## Design Decisions

### Why Separate Upload Calls?

The system makes individual upload calls for each module rather than combining
them into a single call. This is intentional because:

1. **Correct Flag Attribution**: Each coverage file must be uploaded with its
   specific flag to maintain module boundaries.
2. **Avoids Flag Confusion**: Uploading multiple files with multiple flags in
   one command would apply all flags to all files.
3. **Module Isolation**: Each module's coverage changes are tracked
   independently.

### Performance Considerations

While separate uploads add ~20 seconds to CI time, this ensures accurate
coverage tracking. Future optimizations could include:

- Parallel uploads to reduce total time.
- Skipping modules with no coverage changes.
- Using GitHub Action matrix for concurrent uploads.

## Troubleshooting

### No coverage files found

Ensure the index file exists:

```bash
make .tmp/index
```

### Tests failing

Check test output for specific module:

```bash
go -C <module_dir> test -v
```

### Coverage merge issues

The coverage files are merged using the `merge_coverage.sh` helper script.
This properly handles coverage profile headers and data sections. For
debugging, check individual module coverage files in `.tmp/coverage/`.

### Slow uploads

If uploads are taking too long:

1. Check network connectivity.
2. Verify Codecov service status.
3. Consider implementing parallel uploads (see Performance Considerations).

### Flag attribution problems

If coverage is not being attributed to the correct module:

1. Verify each upload specifies only one flag.
2. Check the codecov.yml flag configuration.
3. Ensure coverage files are not being merged before upload.
